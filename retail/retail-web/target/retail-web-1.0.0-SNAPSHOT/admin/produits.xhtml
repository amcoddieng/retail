<ui:composition template="/WEB-INF/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <ui:define name="title">Admin — Gestion des Produits</ui:define>

    <ui:define name="content">
        <f:event type="preRenderView" listener="#{loginBean.checkAccess('ADMIN')}"/>

        <div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 p-6">
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-2xl shadow-xl mb-8">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between p-8">
                    <div class="flex items-center mb-6 lg:mb-0">
                        <div class="bg-white/20 p-4 rounded-2xl mr-6 backdrop-blur-sm">
                            <i class="pi pi-shopping-bag text-3xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-white mb-2">Gestion des Produits</h1>
                            <p class="text-indigo-100 text-lg">Créez et gérez le catalogue de produits</p>
                        </div>
                    </div>
                    <div class="bg-white/10 px-6 py-4 rounded-xl border border-white/20 backdrop-blur-sm">
                        <div class="flex items-center">
                            <i class="pi pi-box text-white text-xl mr-3"></i>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-white">#{adminProduitBean.produits.size()}</div>
                                <div class="text-indigo-100 text-sm">Produits en stock</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="space-y-6">
                <!-- Toolbar Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-800">Actions et Recherche</h3>
                        <p class="text-gray-600 mt-1">Créez de nouveaux produits ou recherchez dans le catalogue</p>
                    </div>

                    <h:form id="toolbarForm">
                        <p:messages id="msgs" showDetail="true" closable="true" 
                                  styleClass="custom-growl"/>
                        
                        <div class="p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div class="flex items-center gap-4">
                                    <p:commandButton value="Nouveau produit" icon="pi pi-plus"
                                                   action="#{adminProduitBean.nouveau}"
                                                   process="@this"
                                                   update="createForm toolbarForm:msgs"
                                                   styleClass="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5"/>
                                </div>
                                
                                <div class="flex-1 max-w-md">
                                    <div class="relative">
                                        <i class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <p:inputText placeholder="Rechercher un produit..." 
                                                   styleClass="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h:form>
                </div>

                <!-- Creation/Edit Form Card -->
                <h:form id="createForm" enctype="multipart/form-data">
                <ui:fragment rendered="#{adminProduitBean.showNew or adminProduitBean.editMode}">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden transform transition-all duration-300">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-indigo-500 p-2 rounded-lg">
                                        <i class="pi #{adminProduitBean.editMode ? 'pi-pencil' : 'pi-plus-circle'} text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-semibold text-gray-800">
                                            #{adminProduitBean.editMode ? 'Modifier le produit' : 'Nouveau produit'}
                                        </h3>
                                        <p class="text-gray-600 text-sm mt-1">
                                            #{adminProduitBean.editMode ? 
                                              'Modifiez les informations du produit' : 
                                              'Ajoutez un nouveau produit au catalogue'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <!-- Libellé -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700">
                                        Nom du produit
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <p:inputText value="#{adminProduitBean.current.libelle}"
                                               required="true" requiredMessage="Le nom du produit est requis"
                                               placeholder="Saisissez le nom du produit"
                                               styleClass="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200"/>
                                </div>

                                <!-- Prix -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700">
                                        Prix (FCFA)
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <p:inputNumber value="#{adminProduitBean.current.prix}"
                                                 minValue="0" decimalPlaces="0"
                                                 required="true" requiredMessage="Le prix est requis"
                                                 placeholder="0"
                                                 styleClass="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200"/>
                                </div>

                                <!-- Stock -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700">
                                        Stock disponible
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <p:inputNumber value="#{adminProduitBean.current.stockDisponible}"
                                                 minValue="0" decimalPlaces="0"
                                                 required="true" requiredMessage="Le stock est requis"
                                                 placeholder="0"
                                                 styleClass="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200"/>
                                </div>

                                <!-- Famille -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-semibold text-gray-700">Famille</label>
                                    <p:selectOneMenu value="#{adminProduitBean.familleId}" 
                                                   styleClass="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                                        <f:selectItem itemLabel="Sélectionnez une famille" itemValue="#{null}"/>
                                        <f:selectItems value="#{adminProduitBean.familles}" var="f"
                                                     itemLabel="#{f.nom}" itemValue="#{f.id}"/>
                                    </p:selectOneMenu>
                                </div>

                                <!-- Image Upload -->
                                <div class="lg:col-span-2 space-y-4">
                                    <label class="block text-sm font-semibold text-gray-700">Image du produit</label>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div class="space-y-3">
                                            <p:fileUpload mode="advanced"
                                                        auto="true"
                                                        label="Choisir une image"
                                                        uploadLabel="Téléverser"
                                                        cancelLabel="Annuler"
                                                        chooseLabel="Parcourir"
                                                        sizeLimit="10242880"
                                                        multiple="false"
                                                        allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
                                                        listener="#{adminProduitBean.upload}"
                                                        update="imagePreview toolbarForm:msgs"
                                                        process="@this"
                                                        styleClass="w-full"/>
                                            <p class="text-xs text-gray-500">Formats acceptés: JPG, PNG, GIF (max 10MB)</p>
                                        </div>
                                        
                                        <div class="flex justify-center">
                                            <p:outputPanel id="imagePreview">
                                                <ui:fragment rendered="#{not empty adminProduitBean.getCurrentImageBase64()}">
                                                    <div class="relative group">
                                                        <img src="#{adminProduitBean.getCurrentImageBase64()}"
                                                             class="w-48 h-48 object-cover rounded-xl border-2 border-gray-300 shadow-md group-hover:shadow-lg transition-shadow duration-200"/>
                                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-xl transition-all duration-200 flex items-center justify-center">
                                                            <span class="text-white opacity-0 group-hover:opacity-100 font-semibold text-sm transition-opacity duration-200">Aperçu</span>
                                                        </div>
                                                    </div>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{empty adminProduitBean.getCurrentImageBase64()}">
                                                    <div class="w-48 h-48 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center bg-gray-50">
                                                        <i class="pi pi-image text-gray-400 text-3xl mb-2"></i>
                                                        <span class="text-gray-500 text-sm text-center">Aucune image sélectionnée</span>
                                                    </div>
                                                </ui:fragment>
                                            </p:outputPanel>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex flex-col sm:flex-row gap-3 justify-end pt-6 border-t border-gray-100">
                                <p:commandButton value="Annuler"
                                               action="#{adminProduitBean.annuler}"
                                               process="@this"
                                               update="createForm"
                                               immediate="true"
                                               styleClass="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors duration-200"/>
                                <p:commandButton value="#{adminProduitBean.editMode ? 'Mettre à jour' : 'Enregistrer'}"
                                               icon="pi pi-check"
                                               action="#{adminProduitBean.save}"
                                               process="@form"
                                               update="toolbarForm:msgs tableForm:produitsTable createForm"
                                               styleClass="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-6 py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5"/>
                            </div>
                        </div>
                    </div>
                </ui:fragment>
                </h:form>

                <!-- Products Table Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-100">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <div class="flex items-center gap-3 mb-4 sm:mb-0">
                                <div class="bg-indigo-500 p-2 rounded-lg">
                                    <i class="pi pi-list text-white text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Catalogue des Produits</h3>
                                    <p class="text-gray-600 text-sm mt-1">
                                        Liste complète des produits disponibles
                                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs font-semibold ml-2">
                                            #{adminProduitBean.produits.size()}
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h:form id="tableForm">
                        <div class="overflow-x-auto">
                            <p:dataTable id="produitsTable" value="#{adminProduitBean.produits}" var="p"
                                       widgetVar="produitsTable" paginator="true" rows="10"
                                       emptyMessage="Aucun produit trouvé"
                                       styleClass="min-w-full divide-y divide-gray-200"
                                       globalFilter="globalFilter"
                                       filteredValue="#{adminProduitBean.filteredProduits}"
                                       paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                       rowsPerPageTemplate="5,10,15,20"
                                       style="border: none;">

                                <!-- Produit -->
                                <p:column headerText="Produit" sortBy="#{p.libelle}" filterBy="#{p.libelle}"
                                        filterMatchMode="contains" 
                                        styleClass="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-shrink-0">
                                            <ui:fragment rendered="#{not empty p.image}">
                                                <img src="#{p.image}" 
                                                     class="w-12 h-12 rounded-lg object-cover border border-gray-200 shadow-sm"/>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{empty p.image}">
                                                <div class="w-12 h-12 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center">
                                                    <i class="pi pi-image text-gray-400 text-lg"></i>
                                                </div>
                                            </ui:fragment>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <p class="text-sm font-semibold text-gray-900 truncate">#{p.libelle}</p>
                                            <ui:fragment rendered="#{p.famille != null}">
                                                <p class="text-sm text-gray-500 truncate">#{p.famille.nom}</p>
                                            </ui:fragment>
                                        </div>
                                    </div>
                                </p:column>

                                <!-- Prix -->
                                <p:column headerText="Prix" sortBy="#{p.prix}" style="width: 120px;"
                                        styleClass="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                                        <span class="text-blue-800 font-bold text-sm">#{p.prix}</span>
                                        <span class="text-blue-600 text-xs ml-1">FCFA</span>
                                    </div>
                                </p:column>

                                <!-- Stock -->
                                <p:column headerText="Stock" sortBy="#{p.stockDisponible}" style="width: 140px;"
                                        styleClass="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center gap-2 px-3 py-2 rounded-lg border #{p.stockDisponible gt 10 ? 'bg-green-50 border-green-200' : (p.stockDisponible gt 0 ? 'bg-yellow-50 border-yellow-200' : 'bg-red-50 border-red-200')}">
                                        <i class="pi pi-box #{p.stockDisponible gt 10 ? 'text-green-600' : (p.stockDisponible gt 0 ? 'text-yellow-600' : 'text-red-600')} text-sm"></i>
                                        <span class="#{p.stockDisponible gt 10 ? 'text-green-800' : (p.stockDisponible gt 0 ? 'text-yellow-800' : 'text-red-800')} font-semibold text-sm">#{p.stockDisponible}</span>
                                        <span class="#{p.stockDisponible gt 10 ? 'text-green-600' : (p.stockDisponible gt 0 ? 'text-yellow-600' : 'text-red-600')} text-xs">
                                            #{p.stockDisponible gt 10 ? 'Disponible' : (p.stockDisponible gt 0 ? 'Stock bas' : 'Rupture')}
                                        </span>
                                    </div>
                                </p:column>

                                <!-- Actions -->
                                <p:column headerText="Actions" style="width: 100px;"
                                        styleClass="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center space-x-2">
                                        <p:commandButton icon="pi pi-pencil" 
                                                       title="Modifier"
                                                       action="#{adminProduitBean.edit(p.id)}"
                                                       process="@this"
                                                       update="createForm toolbarForm:msgs"
                                                       oncomplete="if(!args.validationFailed){ scrollToCreateForm(); }"
                                                       styleClass="w-9 h-9 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center transition-colors duration-200 shadow-sm hover:shadow-md"/>
                                        <p:commandButton icon="pi pi-trash" 
                                                       title="Supprimer"
                                                       action="#{adminProduitBean.delete(p.id)}"
                                                       process="@this"
                                                       update="toolbarForm:msgs produitsTable"
                                                       onclick="return confirm('Supprimer le produit ?')"
                                                       styleClass="w-9 h-9 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center transition-colors duration-200 shadow-sm hover:shadow-md"/>
                                    </div>
                                </p:column>
                            </p:dataTable>
                        </div>

                        <!-- Table Summary -->
                        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="flex items-center space-x-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Stock bon</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Stock bas</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                                        <span class="text-sm text-gray-600">Rupture</span>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    Total: <span class="font-semibold text-gray-700">#{adminProduitBean.produits.size()}</span> produits
                                </div>
                            </div>
                        </div>
                    </h:form>
                </div>
            </div>
        </div>

        <style>
            /* Styles personnalisés pour compléter Tailwind */
            .custom-growl {
                position: relative !important;
                top: auto !important;
                right: auto !important;
                width: 100%;
                margin-bottom: 1rem;
            }

            /* Personnalisation de la pagination PrimeFaces */
            .ui-paginator {
                background: #f9fafb !important;
                border: none !important;
                border-top: 1px solid #e5e7eb !important;
                padding: 1rem 1.5rem !important;
            }

            .ui-paginator .ui-paginator-page,
            .ui-paginator .ui-paginator-first,
            .ui-paginator .ui-paginator-prev,
            .ui-paginator .ui-paginator-next,
            .ui-paginator .ui-paginator-last {
                border: 1px solid #d1d5db !important;
                background: white !important;
                color: #374151 !important;
                border-radius: 8px !important;
                margin: 0 2px !important;
                transition: all 0.2s ease;
            }

            .ui-paginator .ui-state-active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
                color: white !important;
                border-color: #6366f1 !important;
            }

            .ui-paginator .ui-paginator-page:hover,
            .ui-paginator .ui-paginator-first:hover,
            .ui-paginator .ui-paginator-prev:hover,
            .ui-paginator .ui-paginator-next:hover,
            .ui-paginator .ui-paginator-last:hover {
                background: #e0e7ff !important;
                color: #3730a3 !important;
            }

            /* Style pour la table */
            .ui-datatable .ui-datatable-thead > tr > th {
                background: #f8fafc !important;
                border-bottom: 2px solid #e2e8f0 !important;
                font-weight: 600 !important;
                color: #374151 !important;
            }

            .ui-datatable .ui-datatable-data > tr {
                transition: background-color 0.2s ease;
            }

            .ui-datatable .ui-datatable-data > tr:hover {
                background-color: #f8fafc !important;
            }

            .ui-datatable .ui-datatable-data > tr > td {
                border-color: #f1f5f9 !important;
                vertical-align: middle !important;
            }

            /* Style pour le fileUpload */
            .ui-fileupload .ui-fileupload-buttonbar {
                background: #f8fafc !important;
                border: 2px dashed #d1d5db !important;
                border-radius: 12px !important;
                padding: 2rem !important;
            }

            .ui-fileupload .ui-fileupload-content {
                border: none !important;
                background: transparent !important;
            }

            /* Animation pour le formulaire de création */
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .creation-card {
                animation: slideDown 0.3s ease-out;
            }

            /* Style pour le selectOneMenu */
            .ui-selectonemenu {
                width: 100% !important;
            }

            .ui-selectonemenu .ui-selectonemenu-trigger {
                background: #6366f1 !important;
                border-color: #6366f1 !important;
                color: white !important;
            }
        </style>

        <script>
            function scrollToCreateForm() {
                const el = document.querySelector('.creation-card');
                if (el) {
                    window.scrollTo({
                        top: el.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
            }

            // Animation pour les cartes au chargement
            document.addEventListener('DOMContentLoaded', function() {
                const cards = document.querySelectorAll('.bg-white.rounded-2xl');
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        card.style.transition = 'all 0.5s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            });
        </script>
    </ui:define>
</ui:composition>